#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.." || exit 1
rm -f deploy/shutdown.xml

# Initialize arrays
JAVA_OPTS=()
OTHER_OPTS=()

PID_FILE="jpos.pid"
USE_PID=true

for arg in "$@"; do
  case "$arg" in
    -D*)
      JAVA_OPTS+=("$arg")
      ;;
    --pid=*)
      PID_FILE="${arg#--pid=}"
      ;;
    --no-pid)
      USE_PID=false
      ;;
    --debug)
      JAVA_OPTS+=("-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005")
      ;;
    *)
      OTHER_OPTS+=("$arg")
      ;;
  esac
done

if $USE_PID; then
  if [ -f "$PID_FILE" ] && ps -p "$(cat "$PID_FILE")" > /dev/null 2>&1; then
    echo "Process $(cat "$PID_FILE") is running"
    exit 1
  fi
  rm -f "$PID_FILE"
fi

mkdir -p log

# Base JVM invocation
CMD=(
  java -server
  -Xmx4G
  --enable-native-access=ALL-UNNAMED
  --sun-misc-unsafe-memory-access=allow
  -Xlog:gc:log/gc.log
  -jar @jarname@
)

# Only pass --pid if enabled
if $USE_PID; then
  CMD+=( --pid="$PID_FILE" )
fi

# Append opts (nounset-safe)
CMD+=( ${JAVA_OPTS[@]+"${JAVA_OPTS[@]}"} )
CMD+=( ${OTHER_OPTS[@]+"${OTHER_OPTS[@]}"} )

exec "${CMD[@]}"

